<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sof铆a - Plataforma de Casos Pr谩cticos - MY-PROJECT</title>
    <!-- Favicon - Gorro de graduado azul celeste -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>" type="image/svg+xml">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colores exactos de my-project */
            --primary: #4979C0;         /* Azul principal del logo */
            --primary-dark: #2A5898;    /* Azul oscuro */
            --primary-light: #EBF2FF;   /* Azul claro */
            --secondary: #F0A830;       /* Naranja-谩mbar para contraste */
            --secondary-dark: #D98C23;  /* Naranja oscuro */
            --secondary-light: #FFEFD4; /* Naranja claro */
            --accent: #3E6AB0;          /* Azul intermedio para acentos */
            --tertiary: #B0C9F2;        /* Azul p谩lido para fondos suaves */
            --success: #36B37E;         /* Verde para 茅xito */
            --warning: #FBBF24;         /* Amarillo para alertas */
            --error: #EF4444;           /* Rojo para errores */
            --info: #64B5F6;            /* Azul informativo */
            --text-dark: #122550;       /* Azul oscuro/negro para textos */
            --text-light: #FFFFFF;      /* Blanco para textos en fondos oscuros */
            --gray-50: #F9FAFB;         /* Fondo muy claro */
            --gray-100: #F3F4F6;        /* Fondo claro */
            --gray-200: #E5E7EB;        /* Bordes, separadores */
            --gray-300: #D1D5DB;        /* Bordes destacados */
            --gray-400: #9CA3AF;        /* Textos deshabilitados */
            --gray-500: #6B7280;        /* Textos secundarios */
            --gray-600: #4B5563;        /* Textos de nivel medio */
            --gray-700: #374151;        /* Textos primarios */
            --gray-800: #1F2937;        /* Textos destacados */
            --gray-900: #111827;        /* Textos muy destacados */
            --white: #FFFFFF;           /* Blanco puro */
            
            /* Sombras */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 15px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.25);
            
            /* Sombras de brillo */
            --glow-primary: 0 0 20px rgba(73, 121, 192, 0.4);
            --glow-secondary: 0 0 20px rgba(240, 168, 48, 0.4);
            
            /* Border radius */
            --radius-sm: 0.25rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            
            /* Transiciones */
            --transition: all 0.3s ease;
            --transition-bounce: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            
            /* Fuentes */
            --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
            --font-heading: 'Montserrat', sans-serif;
        }

        /* Variables para modo oscuro con MEJOR CONTRASTE */
        [data-theme="dark"] {
            --primary: #6296DF;          /* Azul principal MS claro para mejor contraste */
            --primary-dark: #4A7FCF;     /* Azul oscuro ajustado */
            --primary-light: #1A3366;    /* Azul claro m谩s oscuro */
            --secondary: #FFB445;        /* Naranja-谩mbar m谩s brillante para mejor contraste */
            --secondary-dark: #F0A830;   /* Naranja oscuro */
            --secondary-light: #8C5E1A;  /* Naranja claro m谩s oscuro */
            --text-dark: #FFFFFF;        /* Blanco para textos principales - MXIMO CONTRASTE */
            --text-light: #FFFFFF;       /* Blanco se mantiene */
            --gray-50: #0A1222;          /* Fondo muy oscuro - M谩s oscuro que antes */
            --gray-100: #162032;         /* Fondo oscuro mejorado */
            --gray-200: #293344;         /* Bordes, separadores mejorados */
            --gray-300: #3D4663;         /* Bordes destacados mejorados */
            --gray-400: #6A7595;         /* Textos deshabilitados mejorados - MS CONTRASTE */
            --gray-500: #98A1C2;         /* Textos secundarios mejorados - MS CONTRASTE */
            --gray-600: #CBD0E5;         /* Textos de nivel medio mejorados - MS CONTRASTE */
            --gray-700: #E8ECF7;         /* Textos primarios mejorados - MS CONTRASTE */
            --gray-800: #F3F8FF;         /* Textos destacados mejorados - MS CONTRASTE */
            --gray-900: #FFFFFF;         /* Textos muy destacados mejorados - Blanco puro */
            
            /* Sombras m谩s intensas para modo oscuro */
            --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 8px 18px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 16px 30px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.7);
            
            /* Sombras de brillo en modo oscuro - MS INTENSAS */
            --glow-primary: 0 0 25px rgba(98, 150, 223, 0.5);
            --glow-secondary: 0 0 25px rgba(255, 180, 69, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-sans);
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-700);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Header */
        .app-header {
            background-color: var(--primary);
            color: var(--text-light);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px var(--shadow);
            position: relative;
            z-index: 10;
            transition: background-color 0.5s ease;
        }

        .avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--white);
        }

        .app-title {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Main container */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 1rem;
            position: relative;
        }

        /* Message containers */
        .message-container {
            background-color: var(--white);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(74, 122, 191, 0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--primary);
            color: var(--text-light);
            cursor: pointer;
            transition: background-color 0.5s ease;
        }

        .message-container[data-type="correction"] .message-header {
            background-color: var(--secondary);
        }

        .message-container[data-type="resolution"] .message-header {
            background-color: var(--info);
        }

        .message-type {
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.9rem;
            padding: 0.4rem;
            cursor: pointer;
            border-radius: 50%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
        }

        .icon-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .icon-button span {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .message-content {
            padding: 1.25rem;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--gray-700);
            background-color: var(--white);
            overflow-wrap: break-word;
            transition: color 0.5s ease;
        }

        [data-theme="dark"] .message-content {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }

        .message-content.collapsed {
            display: none;
        }

        .message-content p {
            margin-bottom: 1rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Input section */
        .input-section {
            background-color: var(--white);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-top: auto;
            box-shadow: var(--shadow);
            border: 1px solid rgba(74, 122, 191, 0.1);
            transition: background-color 0.5s ease;
        }

        [data-theme="dark"] .input-section {
            background-color: var(--gray-100);
        }

        .response-field {
            position: relative;
            margin-bottom: 1rem;
        }

        .textarea-container {
            position: relative;
        }

        .response-field textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            background: var(--white);
            color: var(--gray-700);
            font-size: 1rem;
            outline: none;
            resize: none;
            height: 150px;
            transition: var(--transition), background-color 0.5s ease, color 0.5s ease;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .response-field textarea {
            background: var(--gray-100);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .response-field textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 122, 191, 0.1);
        }

        .expand-button {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background-color: var(--primary);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition), background-color 0.5s ease;
            z-index: 5;
        }

        .expand-button:hover {
            background-color: var(--secondary);
        }

        .button-container {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .action-button {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: var(--font-sans);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .primary-button {
            background-color: var(--primary);
            color: var(--text-light);
        }

        .primary-button:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 122, 191, 0.2);
        }

        .primary-button:active {
            transform: translateY(0);
        }

        .secondary-button {
            background-color: var(--secondary);
            color: var(--text-light);
        }

        .secondary-button:hover:not(:disabled) {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 168, 48, 0.2);
        }

        .info-button {
            background-color: var(--info);
            color: var(--text-light);
        }

        .info-button:hover:not(:disabled) {
            background-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 122, 191, 0.2);
        }

        /* Loader moderno */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        [data-theme="dark"] .loader-overlay {
            background-color: rgba(10, 18, 34, 0.9);
        }

        .loader-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loader-container {
            background-color: var(--white);
            border-radius: var(--radius-md);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(74, 122, 191, 0.1);
            transition: background-color 0.5s ease;
        }

        [data-theme="dark"] .loader-container {
            background-color: var(--gray-100);
            border-color: var(--primary-light);
        }

        .modern-loader {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto 1.5rem;
        }

        .modern-loader:before, .modern-loader:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--secondary);
        }

        .modern-loader:before {
            z-index: 100;
            animation: spin 1.5s infinite;
        }

        .modern-loader:after {
            border-top-color: var(--primary);
            border-bottom-color: var(--primary);
            animation: spin 2s infinite alternate;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.1);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }

        .loader-message {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            transition: color 0.5s ease;
        }

        [data-theme="dark"] .loader-message {
            color: var(--secondary);
        }

        .loader-details {
            font-size: 0.9rem;
            color: var(--gray-500);
            transition: color 0.5s ease;
        }

        [data-theme="dark"] .loader-details {
            color: var(--gray-500);
        }

        /* Expanded modes */
        .reading-mode-container,
        .writing-mode-container,
        .feedback-mode-container,
        .resolution-mode-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 250, 252, 0.97);
            z-index: 500;
            padding: 2rem;
            display: none;
            flex-direction: column;
            transition: background-color 0.5s ease;
        }

        [data-theme="dark"] .reading-mode-container,
        [data-theme="dark"] .writing-mode-container,
        [data-theme="dark"] .feedback-mode-container,
        [data-theme="dark"] .resolution-mode-container {
            background-color: rgba(10, 18, 34, 0.97);
        }

        .mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .mode-title {
            font-family: var(--font-heading);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            transition: color 0.5s ease;
        }

        [data-theme="dark"] .mode-title {
            color: var(--secondary);
        }

        .resolution-mode-container .mode-title {
            color: var(--info);
        }

        [data-theme="dark"] .resolution-mode-container .mode-title {
            color: var(--secondary);
        }

        .mode-close {
            background-color: var(--primary);
            color: var(--text-light);
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition), background-color 0.5s ease;
            font-family: var(--font-sans);
        }

        .resolution-mode-container .mode-close {
            background-color: var(--info);
        }

        [data-theme="dark"] .resolution-mode-container .mode-close {
            background-color: var(--secondary);
        }

        .mode-close:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .resolution-mode-container .mode-close:hover {
            background-color: var(--accent);
        }

        [data-theme="dark"] .resolution-mode-container .mode-close:hover {
            background-color: var(--secondary-dark);
        }

        .mode-content {
            flex: 1;
            overflow-y: auto;
            background-color: var(--white);
            padding: 2rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            border: 1px solid rgba(74, 122, 191, 0.1);
            transition: background-color 0.5s ease;
        }

        [data-theme="dark"] .mode-content {
            background-color: var(--gray-100);
            border-color: var(--gray-300);
        }

        .writing-mode-container .mode-content {
            display: flex;
            flex-direction: column;
        }

        .writing-mode-container textarea {
            flex: 1;
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            resize: none;
            font-size: 1rem;
            line-height: 1.6;
            outline: none;
            background-color: var(--white);
            color: var(--gray-700);
            transition: var(--transition), background-color 0.5s ease, color 0.5s ease;
        }

        [data-theme="dark"] .writing-mode-container textarea {
            background-color: var(--gray-100);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .writing-mode-container textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 122, 191, 0.1);
        }

        [data-theme="dark"] .writing-mode-container textarea:focus {
            border-color: var(--secondary);
        }

        .writing-mode-container .button-container {
            margin-top: 1rem;
        }

        /* Estilos para la calificaci贸n */
        .grade-display {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-md);
            margin-left: 0.5rem;
            font-weight: 600;
            background-color: var(--secondary);
            color: var(--text-light);
            transition: background-color 0.5s ease;
        }

        [data-theme="dark"] .grade-display {
            background-color: var(--secondary);
        }

        /* Theme toggle button */
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: var(--white);
            border: 1px solid var(--gray-200);
            cursor: pointer;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--secondary);
            border-radius: 50%;
            transition: var(--transition-bounce);
            z-index: 15;
            box-shadow: var(--shadow);
        }

        .theme-toggle:hover {
            transform: translateY(-3px) rotate(15deg);
            box-shadow: var(--shadow-md), var(--glow-secondary);
        }

        [data-theme="dark"] .theme-toggle {
            background-color: var(--gray-800);
            border-color: var(--primary);
            color: var(--secondary);
            box-shadow: var(--shadow), var(--glow-secondary);
        }

        [data-theme="dark"] .theme-toggle:hover {
            box-shadow: var(--shadow-lg), var(--glow-secondary);
            border-color: var(--secondary);
        }

        /* Mejoras para responsividad */
        @media (max-width: 992px) {
            .app-header {
                padding: 0.75rem 1.5rem;
            }

            .main-container {
                padding: 0.75rem;
            }

            .reading-mode-container,
            .writing-mode-container,
            .feedback-mode-container,
            .resolution-mode-container {
                padding: 1.5rem;
            }
            
            .theme-toggle {
                top: 0.75rem;
                right: 0.75rem;
                width: 2.25rem;
                height: 2.25rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0.75rem 1rem;
            }

            .app-title {
                font-size: 1rem;
            }

            .main-container {
                padding: 0.75rem;
            }

            .message-header {
                padding: 0.6rem 0.75rem;
            }

            .message-content {
                padding: 1rem;
                font-size: 0.95rem;
            }

            .input-section {
                padding: 1rem;
            }

            .button-container {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .action-button {
                min-width: calc(50% - 0.375rem);
                flex: 0 0 calc(50% - 0.375rem);
            }

            .reading-mode-container,
            .writing-mode-container,
            .feedback-mode-container,
            .resolution-mode-container {
                padding: 1rem;
            }

            .mode-content {
                padding: 1rem;
            }
            
            .icon-button span {
                display: none;
            }
            
            .theme-toggle {
                top: 0.5rem;
                right: 0.5rem;
                width: 2rem;
                height: 2rem;
            }
        }

        @media (max-width: 480px) {
            .avatar {
                width: 2rem;
                height: 2rem;
            }

            .app-title {
                font-size: 0.9rem;
            }

            .message-type {
                font-size: 0.8rem;
            }

            .icon-button {
                font-size: 0.8rem;
                padding: 0.3rem;
            }

            .response-field textarea {
                padding: 0.75rem;
                font-size: 0.95rem;
                height: 120px;
            }

            .modal-title, .mode-title {
                font-size: 1.1rem;
            }

            .mode-close {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .action-button {
                min-width: 100%;
                flex: 0 0 100%;
                margin-bottom: 0.375rem;
            }
            
            .theme-toggle {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.9rem;
            }
        }

        /* Height-specific adjustments for small screens */
        @media (max-height: 700px) {
            .reading-mode-container,
            .writing-mode-container,
            .feedback-mode-container,
            .resolution-mode-container {
                padding: 1rem;
            }
            
            .mode-content {
                padding: 1.5rem;
            }
            
            .mode-title {
                font-size: 1.1rem;
            }
        }

        /* Handle device orientations */
        @media (orientation: landscape) and (max-height: 500px) {
            .reading-mode-container,
            .writing-mode-container,
            .feedback-mode-container,
            .resolution-mode-container {
                padding: 0.75rem;
                overflow-y: auto;
            }
            
            .mode-content {
                padding: 1rem;
            }
            
            .mode-title {
                font-size: 1rem;
            }
            
            .mode-close {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Cambiar tema">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Header -->
    <header class="app-header">
        <img src="{{ url_for('get_examinadora_photo', id=examinador_id) }}" alt="Sofia" class="avatar">
        <h1 class="app-title">Sof铆a - Cuerpo de Gesti贸n de la Administraci贸n Civil del Estado</h1>
    </header>

    <!-- Main container -->
    <main class="main-container" id="main-container">
        <!-- Messages will be dynamically added here -->
    </main>

    <!-- Input section -->
    <section class="input-section" id="input-section">
        <div class="button-container">
            <button id="exerciseButton" class="action-button primary-button">
                <i class="fas fa-file-alt"></i>
                Pedir Ejercicio
            </button>
            <button id="resolutionButton" class="action-button info-button" disabled>
                <i class="fas fa-check-circle"></i>
                Mostrar Resoluci贸n
            </button>
        </div>
    </section>

    <!-- Reading mode container (Caso pr谩ctico) -->
    <div class="reading-mode-container" id="readingModeContainer">
        <div class="mode-header">
            <h2 class="mode-title">Modo Lectura - Caso Pr谩ctico</h2>
            <button class="mode-close" id="closeReadingMode">
                <i class="fas fa-times"></i>
                Salir de Modo Lectura
            </button>
        </div>
        <div class="mode-content" id="readingModeContent">
            <!-- Content will be inserted here -->
        </div>
    </div>

    <!-- Writing mode container -->
    <div class="writing-mode-container" id="writingModeContainer">
        <div class="mode-header">
            <h2 class="mode-title">Modo Redacci贸n</h2>
            <button class="mode-close" id="closeWritingMode">
                <i class="fas fa-times"></i>
                Salir de Modo Redacci贸n
            </button>
        </div>
        <div class="mode-content">
            <textarea id="expandedResponseText" placeholder="Redacta tu respuesta con m谩s espacio..."></textarea>
            <div class="button-container">
                <button id="saveExpandedText" class="action-button primary-button">
                    <i class="fas fa-save"></i>
                    Guardar y Salir
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback mode container (Evaluaci贸n de Claude) -->
    <div class="feedback-mode-container" id="feedbackModeContainer">
        <div class="mode-header">
            <h2 class="mode-title">Retroalimentaci贸n Detallada</h2>
            <button class="mode-close" id="closeFeedbackMode">
                <i class="fas fa-times"></i>
                Salir de Retroalimentaci贸n
            </button>
        </div>
        <div class="mode-content" id="feedbackModeContent">
            <!-- Content will be inserted here -->
        </div>
    </div>

    <!-- Resolution mode container (Correcci贸n de la BD) -->
    <div class="resolution-mode-container" id="resolutionModeContainer">
        <div class="mode-header">
            <h2 class="mode-title">Resoluci贸n Oficial</h2>
            <button class="mode-close" id="closeResolutionMode">
                <i class="fas fa-times"></i>
                Salir de Resoluci贸n
            </button>
        </div>
        <div class="mode-content" id="resolutionModeContent">
            <!-- Content will be inserted here -->
        </div>
    </div>

    <!-- Loader overlay -->
    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader-container">
            <div class="modern-loader"></div>
            <div class="loader-message" id="loaderMessage">Procesando...</div>
            <div class="loader-details" id="loaderDetails">Consultando la normativa vigente...</div>
        </div>
    </div>

    <script>
        // Sistema de tema claro/oscuro
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const themeIcon = themeToggle.querySelector('i');
        
        // Verificar si hay un tema guardado en localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.setAttribute('data-theme', savedTheme);
        
        // Actualizar icono seg煤n el tema
        updateThemeIcon();
        
        // Funci贸n para actualizar el icono del tema
        function updateThemeIcon() {
            if (body.getAttribute('data-theme') === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }
        
        // Manejar el toggle del tema
        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            updateThemeIcon();
        });

        // Variables de estado
        let exerciseGenerated = false;
        let hasResolutionBeenShown = false;
        
        // Almacenamiento de contenido para los PDF
        const exerciseContent = {
            exercise: '',
            resolution: ''
        };
        
        // Sistema de Loader Inteligente
        const LoaderManager = {
            overlay: document.getElementById('loaderOverlay'),
            message: document.getElementById('loaderMessage'),
            details: document.getElementById('loaderDetails'),
            messageInterval: null,
            
            messages: {
                'exercise': {
                    messages: [
                        'Generando ejercicio...',
                        'Revisando el material oficial...',
                        'Consultando el BOE...',
                        'Analizando la normativa vigente...',
                        'Elaborando el caso pr谩ctico...',
                        'Verificando la complejidad...',
                        'Dise帽ando supuestos pr谩cticos...',
                        'Verificando bases del caso...',
                        'Consultando jurisprudencia reciente...',
                        'Elaborando preguntas clave...',
                        'Adaptando nivel de dificultad...',
                        'Estructurando elementos del caso...'
                    ],
                    details: [
                        'Preparando contenido...',
                        'Consultando la legislaci贸n vigente...',
                        'Estructurando el ejercicio...',
                        'Compilando las preguntas...',
                        'Aplicando criterios de evaluaci贸n...',
                        'Revisando la actualidad legislativa...',
                        'Adaptando a la 煤ltima jurisprudencia...',
                        'Integrando textos legales pertinentes...',
                        'Validando concordancia normativa...',
                        'Aplicando enfoque pr谩ctico...',
                        'Incorporando elementos de an谩lisis...',
                        'Asegurando precisi贸n t茅cnica...'
                    ]
                },
                'resolution': {
                    messages: [
                        'Obteniendo resoluci贸n oficial...',
                        'Recuperando soluci贸n de referencia...',
                        'Consultando criterios de correcci贸n...',
                        'Accediendo a la soluci贸n modelo...',
                        'Cargando respuesta correcta...',
                        'Preparando material de referencia...',
                        'Recuperando modelo de respuesta...'
                    ],
                    details: [
                        'Consultando la base de datos...',
                        'Preparando presentaci贸n de la soluci贸n...',
                        'Obteniendo referencias normativas...',
                        'Verificando correcci贸n oficial...',
                        'Compilando informaci贸n para presentaci贸n...',
                        'Formateando contenido para mejor lectura...',
                        'Aplicando destacados a puntos clave...'
                    ]
                }
            },
            
            // Mostrar loader y comenzar animaci贸n de mensajes
            show(type) {
                this.stopAnimation();
                
                const config = this.messages[type];
                this.overlay.classList.add('active');
                
                // Establecer mensaje inicial
                let currentIndex = 0;
                this.message.textContent = config.messages[currentIndex];
                this.details.textContent = config.details[currentIndex];
                
                // Iniciar rotaci贸n de mensajes
                this.messageInterval = setInterval(() => {
                    currentIndex = (currentIndex + 1) % config.messages.length;
                    this.message.textContent = config.messages[currentIndex];
                    this.details.textContent = config.details[currentIndex];
                }, 3000); // Cambiar mensaje cada 3 segundos
                
                return new Promise(resolve => {
                    this.resolve = resolve;
                });
            },
            
            // Detener animaci贸n de mensajes
            stopAnimation() {
                if (this.messageInterval) {
                    clearInterval(this.messageInterval);
                    this.messageInterval = null;
                }
            },
            
            // Finalizar el loader
            finish(type) {
                this.stopAnimation();
                
                // Mensaje de finalizaci贸n
                if (type === 'resolution') {
                    this.message.textContent = 'Resoluci贸n recuperada';
                    this.details.textContent = 'Soluci贸n oficial disponible';
                } else {
                    this.message.textContent = 'Ejercicio generado';
                    this.details.textContent = 'Puede visualizar el ejercicio';
                }
                
                // Ocultar despu茅s de un breve retraso para leer el mensaje final
                setTimeout(() => {
                    this.hide();
                    if (this.resolve) this.resolve();
                }, 800);
            },
            
            // Ocultar el loader inmediatamente
            hide() {
                this.overlay.classList.remove('active');
                this.stopAnimation();
                if (this.resolve) this.resolve();
            }
        };
    
        // Funci贸n para formatear texto
        function formatText(text) {
            return text
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/\r/g, '')
                .trim();
        }
    
        // Function to add a message to the UI - Versi贸n modificada
        function addMessage(text, type = 'response') {
            const mainContainer = document.getElementById('main-container');
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            messageContainer.dataset.type = type;
            
            // Almacenar el contenido para futuro uso
            if (type === 'exercise') {
                exerciseContent.exercise = text;
            } else if (type === 'resolution') {
                exerciseContent.resolution = text;
            }
            
            let typeText = '';
            let iconClass = '';
            let hasModeButton = false;
            let modeType = '';
            
            switch(type) {
                case 'exercise':
                    typeText = 'Caso pr谩ctico';
                    iconClass = 'fa-file-alt';
                    hasModeButton = true;
                    modeType = 'reading';
                    break;
                case 'resolution':
                    typeText = 'Resoluci贸n Oficial';
                    iconClass = 'fa-book';
                    hasModeButton = true;
                    modeType = 'resolution';
                    break;
                case 'error':
                    typeText = 'Error';
                    iconClass = 'fa-exclamation-circle';
                    break;
            }
            
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            
            const messageType = document.createElement('div');
            messageType.className = 'message-type';
            messageType.innerHTML = `<i class="fas ${iconClass}"></i> ${typeText}`;
            
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            
            if (hasModeButton) {
                const modeButton = document.createElement('button');
                modeButton.className = 'icon-button mode-toggle';
                
                if (modeType === 'reading') {
                    modeButton.title = 'Modo Lectura';
                    modeButton.innerHTML = `<i class="fas fa-eye"></i><span>Lectura</span>`;
                    modeButton.onclick = function(e) {
                        e.stopPropagation();
                        enterReadingMode(text);
                    };
                } else if (modeType === 'resolution') {
                    modeButton.title = 'Ver Resoluci贸n Completa';
                    modeButton.innerHTML = `<i class="fas fa-book-open"></i><span>Completa</span>`;
                    modeButton.onclick = function(e) {
                        e.stopPropagation();
                        enterResolutionMode(text);
                    };
                }
                
                messageActions.appendChild(modeButton);
            }
            
            const toggleButton = document.createElement('button');
            toggleButton.className = 'icon-button toggle-content';
            toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
            messageActions.appendChild(toggleButton);
            
            messageHeader.appendChild(messageType);
            messageHeader.appendChild(messageActions);
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Para ejercicios y resoluciones, aplicar formato de p谩rrafos
            if (type === 'resolution' || type === 'exercise') {
                messageContent.innerHTML = `<p>${formatText(text)}</p>`;
            } else {
                // Para otros tipos de mensajes (error, etc.)
                messageContent.innerHTML = text;
            }
            
            messageContainer.appendChild(messageHeader);
            messageContainer.appendChild(messageContent);
            mainContainer.appendChild(messageContainer);
            
            messageContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
            
            // Toggle functionality
            toggleButton.onclick = function(e) {
                e.stopPropagation();
                messageContent.classList.toggle('collapsed');
                toggleButton.innerHTML = messageContent.classList.contains('collapsed') 
                    ? '<i class="fas fa-chevron-down"></i>' 
                    : '<i class="fas fa-chevron-up"></i>';
            };
            
            messageHeader.onclick = function() {
                messageContent.classList.toggle('collapsed');
                toggleButton.innerHTML = messageContent.classList.contains('collapsed') 
                    ? '<i class="fas fa-chevron-down"></i>' 
                    : '<i class="fas fa-chevron-up"></i>';
            };
            
            // Si es una resoluci贸n, actualizar estados
            if (type === 'resolution') {
                hasResolutionBeenShown = true;
            }
            
            return messageContainer;
        }
        
        // Function to enter reading mode
        function enterReadingMode(content) {
            const readingModeContent = document.getElementById('readingModeContent');
            readingModeContent.innerHTML = `<p>${formatText(content)}</p>`;
            document.getElementById('readingModeContainer').style.display = 'flex';
        }
        
        // Function to exit reading mode
        document.getElementById('closeReadingMode').addEventListener('click', function() {
            document.getElementById('readingModeContainer').style.display = 'none';
        });
        
        // Function to enter resolution mode
        function enterResolutionMode(content) {
            const resolutionModeContent = document.getElementById('resolutionModeContent');
            
            // Extraer el contenido si es un objeto JSON
            if (typeof content === 'object') {
                content = content.content || content.texto || content.correction_content || JSON.stringify(content);
            } else if (typeof content === 'string' && content.trim().startsWith('{') && content.trim().endsWith('}')) {
                try {
                    const jsonObj = JSON.parse(content);
                    content = jsonObj.content || jsonObj.texto || jsonObj.correction_content || content;
                } catch (e) {
                    console.log("No se pudo parsear como JSON:", e);
                }
            }
            
            resolutionModeContent.innerHTML = `<p>${formatText(content)}</p>`;
            document.getElementById('resolutionModeContainer').style.display = 'flex';
        }
        
        // Function to exit resolution mode
        document.getElementById('closeResolutionMode').addEventListener('click', function() {
            document.getElementById('resolutionModeContainer').style.display = 'none';
        });
    
        // Procesar la respuesta de la resoluci贸n 
        function processResolutionResponse(data) {
            if (!data) return null;
    
            // Si es un objeto, intentar extraer el contenido
            if (typeof data === 'object') {
                return data.content || data.texto || data.correction_content || JSON.stringify(data);
            }
            
            // Si no, devolver tal cual
            return data;
        }
    
        // Send request to the server - Versi贸n simplificada
        async function sendRequest(action) {
            let url = '';
    
            // L贸gica para manejar la acci贸n 'exercise'
            if (action === 'exercise') {
                url = '/get_new_exam';
                document.getElementById('exerciseButton').disabled = true;
                document.getElementById('main-container').innerHTML = '';
                document.getElementById('resolutionButton').disabled = true;
                exerciseGenerated = false;
                hasResolutionBeenShown = false;
    
                try {
                    const loaderPromise = LoaderManager.show('exercise');
    
                    const response = await fetch(url, {
                        method: 'GET',
                    });
    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const data = await response.json();
                    LoaderManager.finish('exercise');
                    await loaderPromise;
    
                    addMessage(data.content, 'exercise');
                    document.getElementById('exerciseButton').disabled = true;
                    document.getElementById('resolutionButton').disabled = false;
                    exerciseGenerated = true;
                } catch (error) {
                    console.error('Error:', error);
                    LoaderManager.hide();
                    addMessage('Error en la comunicaci贸n. Por favor, intenta de nuevo.', 'error');
                    document.getElementById('exerciseButton').disabled = false;
                    document.getElementById('resolutionButton').disabled = true;
                }
            } 
            // L贸gica para manejar la acci贸n 'resolution'
            else if (action === 'resolution') {
                url = '/get_correccion';
                document.getElementById('resolutionButton').disabled = true;
    
                try {
                    const loaderPromise = LoaderManager.show('resolution'); 
                    
                    const response = await fetch(url, {
                        method: 'GET',
                    });
    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    LoaderManager.finish('resolution');
                    await loaderPromise;
                    
                    // Procesar y mostrar la resoluci贸n
                    const resolutionContent = processResolutionResponse(data);
                    
                    if (resolutionContent) {
                        addMessage(resolutionContent, 'resolution');
                        hasResolutionBeenShown = true;
                        document.getElementById('exerciseButton').disabled = false; // Permitir pedir nuevo ejercicio
                        
                        // Colapsar mensaje del ejercicio
                        const messageContainer = document.querySelector('[data-type="exercise"]');
                        if (messageContainer) {
                            const messageContent = messageContainer.querySelector('.message-content');
                            const toggleButton = messageContainer.querySelector('.toggle-content');
                            messageContent.classList.add('collapsed');
                            toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
                        }
                    } else {
                        addMessage('No se encontr贸 ninguna resoluci贸n en la base de datos.', 'error');
                    }
                    
                    document.getElementById('resolutionButton').disabled = false;
                } catch (error) {
                    console.error('Error al obtener resoluci贸n:', error);
                    LoaderManager.hide();
                    addMessage('Error al obtener la resoluci贸n de la base de datos. Por favor, intenta de nuevo.', 'error');
                    document.getElementById('resolutionButton').disabled = false;
                    document.getElementById('exerciseButton').disabled = false; // Permitir pedir nuevo ejercicio en caso de error
                }
            }
        }
    
        // Event listeners - Solo para los botones que quedan
        document.getElementById('exerciseButton').addEventListener('click', function() {
            sendRequest('exercise');
        });
        
        document.getElementById('resolutionButton').addEventListener('click', function() {
            sendRequest('resolution');
        });
    </script>
</body>
</html>